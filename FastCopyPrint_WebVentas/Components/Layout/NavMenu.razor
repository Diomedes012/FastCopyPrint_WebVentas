@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable
@inject NavigationManager NavigationManager

<MudNavMenu Class="mud-width-full py-2">

    <MudText Typo="Typo.subtitle2" Color="Color.Inherit" Class="ml-4 my-2"><b>General</b></MudText>

    <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Storefront">Catálogo</MudNavLink>

    <AuthorizeView Roles="Cliente">
        <Authorized>
            <MudNavLink Href="/carrito" Icon="@Icons.Material.Filled.ShoppingCart">Mi Carrito</MudNavLink>
            <MudNavLink Href="/cliente/mis-compras" Icon="@Icons.Material.Filled.ShoppingBag">Mis Compras</MudNavLink>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Roles="Encargado">
        <Authorized>
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.subtitle2" Color="Color.Inherit" Class="ml-4 mt-2 my-2"><b>Administración</b></MudText>

            <MudNavLink Href="/admin/dashboard" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>

            <MudNavGroup Title="Inventario" Icon="@Icons.Material.Filled.Inventory" Expanded="true">
                <MudNavLink Href="/admin/productos" Icon="@Icons.Material.Filled.Inventory2" Class="ml-2">Productos</MudNavLink>
                <MudNavLink Href="/admin/categorias" Icon="@Icons.Material.Filled.Category" Class="ml-2">Categorías</MudNavLink>
            </MudNavGroup>

            <MudNavLink Href="/admin/ventas" Icon="@Icons.Material.Filled.History">Historial Ventas</MudNavLink>
        </Authorized>
    </AuthorizeView>

    <MudDivider Class="my-2" />
    <MudText Typo="Typo.subtitle2" Color="Color.Inherit" Class="ml-4 my-2"><b>Cuenta</b></MudText>

    <AuthorizeView>
        <Authorized>
            <MudNavLink Href="Account/Manage" Icon="@Icons.Material.Filled.Person">
                @(context.User.Identity?.Name ?? "Mi Perfil")
            </MudNavLink>

            <form action="Account/Logout" method="post">
                <AntiforgeryToken />
                <input type="hidden" name="ReturnUrl" value="@currentUrl" />

                <div class="mud-nav-item">
                    <button type="submit" class="mud-nav-link mud-ripple">
                        <MudIcon Icon="@Icons.Material.Filled.Logout" Class="mud-nav-link-icon" />
                        <span class="mud-nav-link-text">Cerrar Sesión</span>
                    </button>
                </div>
            </form>
        </Authorized>
        <NotAuthorized>
            <div class="mud-nav-item">
                <a href="/Account/Login" class="mud-nav-link">
                    <MudIcon Icon="@Icons.Material.Filled.Login" Class="mud-nav-link-icon" />
                    <span class="mud-nav-link-text">Iniciar Sesión</span>
                </a>
            </div>

            <div class="mud-nav-item">
                <a href="/Account/Register" class="mud-nav-link">
                    <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Class="mud-nav-link-icon" />
                    <span class="mud-nav-link-text">Registrarse</span>
                </a>
            </div>
        </NotAuthorized>
    </AuthorizeView>

</MudNavMenu>

@code {
    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}